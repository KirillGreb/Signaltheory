#include <VirtualWire.h>
#include <Servo.h>

// Пин для управления мотором
#define MOTOR_PIN 9
// Пин для управления рулем
#define RUDDER_PIN 10

// Текущие значения управления
int motorSpeed = 0;
int rudderAngle = 90; // 90 - прямо

// Расстояние от пульта
float distance = 0;

Servo motor;
Servo rudder;

void setup() {
  // Инициализация Serial для отладки
  Serial.begin(9600);
  
  // Инициализация радиомодуля
  vw_setup(2000); // Скорость передачи 2000 бит/с
  vw_set_rx_pin(11); // Пин для приема данных
  vw_rx_start(); // Начинаем прослушивание
  
  // Инициализация сервоприводов
  motor.attach(MOTOR_PIN);
  rudder.attach(RUDDER_PIN);
  
  // Установка начальных значений
  motor.write(90); // Остановка мотора
  rudder.write(90); // Прямо
}

void loop() {
  uint8_t buf[VW_MAX_MESSAGE_LEN];
  uint8_t buflen = VW_MAX_MESSAGE_LEN;
  
  // Проверяем, есть ли данные
  if (vw_get_message(buf, &buflen)) {
    // Преобразуем полученные данные в строку
    String receivedData = "";
    for (int i = 0; i < buflen; i++) {
      receivedData += (char)buf[i];
    }
    
    // Парсим данные (формат: "speed,angle,distance")
    int commaIndex1 = receivedData.indexOf(',');
    int commaIndex2 = receivedData.indexOf(',', commaIndex1 + 1);
    
    if (commaIndex1 != -1 && commaIndex2 != -1) {
      motorSpeed = receivedData.substring(0, commaIndex1).toInt();
      rudderAngle = receivedData.substring(commaIndex1 + 1, commaIndex2).toInt();
      distance = receivedData.substring(commaIndex2 + 1).toFloat();
      
      // Автоматический разворот при превышении 450 метров
      if (distance >= 450) {
        rudderAngle = 180; // Полный поворот
        motorSpeed = map(motorSpeed, 0, 180, 180, 0); // Реверс скорости
      }
      
      // Управление мотором и рулем
      motor.write(motorSpeed);
      rudder.write(rudderAngle);
    }
  }
  
  delay(50);
}
